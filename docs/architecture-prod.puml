@startuml
title FFE â€“ Prod architecture (root_domain = fullfrontend.be)

skinparam backgroundColor #ffffff
skinparam componentStyle rectangle

actor User

rectangle "DigitalOcean DNS" as DODNS
database "DO Spaces\n(Velero backups)" as Spaces

node "Kubernetes (DOKS)\nnode pool autoscaling" {
  frame "infra namespace" {
    component "Traefik\n(LoadBalancer ingress)" as Traefik
    component "cert-manager"
    component "external-dns"
    component "Velero"
  }

  frame "data namespace" {
    database "Postgres\n(postgres.data)" as Postgres
    database "MariaDB\n(mariadb.data)" as MariaDB
  }

  frame "apps namespace" {
    component "WordPress\nhost: fullfrontend.be" as WP
    component "n8n\nhosts: n8n.fullfrontend.be\nwebhook.fullfrontend.be" as N8N
    component "Analytics (Vince)\nhost: insights.fullfrontend.be" as Vince
    component "Registry (Zot)\nhost: registry.fullfrontend.be" as Zot
    component "Nextcloud (planned)" as Nextcloud
    component "Mailu (planned)" as Mailu
  }
}

User --> DODNS
DODNS --> Traefik
Traefik --> WP
Traefik --> N8N
Traefik --> Vince
Traefik --> Zot
Traefik --> Mailu
Traefik --> Nextcloud

WP --> MariaDB
N8N --> Postgres
Vince --> Postgres
Zot --> Postgres
Mailu --> Postgres
Nextcloud --> Postgres
"Postgres" ..> "Velero" : backups
"MariaDB" ..> "Velero" : backups

WP --> "external-dns"
N8N --> "external-dns"
Vince --> "external-dns"
Zot --> "external-dns"
Mailu --> "external-dns"
Nextcloud --> "external-dns"
"external-dns" ..> DODNS : auto-update

WP --> "cert-manager"
N8N --> "cert-manager"
Vince --> "cert-manager"
Zot --> "cert-manager"
Mailu --> "cert-manager"
Nextcloud --> "cert-manager"
"cert-manager" ..> DODNS : auto-update

Velero --> Spaces

note right of Traefik
IngressController (LoadBalancer)
routes to apps namespace
end note

note bottom of Postgres
DB init via init job (admin secret)
end note

note bottom of MariaDB
DB init via init job (admin secret)
end note

legend left
Prod settings:
- root_domain_prod = fullfrontend.be
- Velero -> Spaces bucket
- external-dns -> DO DNS
- cert-manager enabled
-- Registry exposed via ingress (Zot)
endlegend

@enduml
