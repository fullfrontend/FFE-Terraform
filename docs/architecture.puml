@startuml
title FFE – Transition : actuel → cible Kubernetes (root_domain = fullfrontend.be)

left to right direction
skinparam shadowing false
skinparam rectangle {
  BackgroundColor #f7f7f7
  BorderColor #555
  BackgroundColor<<infra>> #dfe9ff
  BackgroundColor<<data>>  #e8ffe8
  BackgroundColor<<apps>>  #ffe8e8
}

package "État actuel" {
  rectangle "Internet" as internet {
    rectangle "DNS / Web\nfullfrontend.be" as dns_cur
    rectangle "Mail (MX/IMAP/SMTP)\nmail.fullfrontend.be" as mail_public
  }

  rectangle "Serveur Mailinabox\n(Cloud – Ubuntu 22.04)" as miab {
    rectangle "DNS zone\nfullfrontend.be" as miab_dns
    rectangle "Mail (SMTP/IMAP)\nmail.fullfrontend.be" as miab_mail
    rectangle "Nextcloud\ncloud.fullfrontend.be" as miab_nc
  }

  rectangle "Serveur Docker prod\n(Cloud – Ubuntu 24.04)" as docker {
    rectangle "Traefik\n(reverse proxy)" as traefik_cur
    rectangle "WordPress\nfullfrontend.be" as wp_cur
    rectangle "Mautic\nmautic.fullfrontend.be" as mautic_cur
  }

  internet --> traefik_cur : HTTP(S)
  internet --> miab_mail : MX/IMAP/SMTP
  traefik_cur --> wp_cur
  traefik_cur --> mautic_cur
  miab_dns --> dns_cur : zone + records
  dns_cur --> traefik_cur : A/AAAA
  dns_cur --> mail_public : MX
}

package "Cible Kubernetes" {
  rectangle "Internet / DNS" as dns {
    rectangle "FQDN:\n- fullfrontend.be (WordPress)\n- n8n.fullfrontend.be\n- webhook.fullfrontend.be\n- cloud.fullfrontend.be\n- mail.fullfrontend.be" as fqdn
  }

  rectangle "Cluster DOKS (prod)" {
    rectangle "Namespace infra" <<infra>> {
      rectangle "Traefik\n(Ingress)" as traefik
      rectangle "cert-manager" as cert
      rectangle "external-dns" as extdns
      rectangle "Velero\n(backups → Spaces)" as velero_do
    }

    rectangle "Namespace data" <<data>> {
      rectangle "Postgres\n(StatefulSet + PVC)" as pg
      rectangle "MariaDB\n(StatefulSet + PVC)" as mariadb
    }

    rectangle "Namespace apps" <<apps>> {
      rectangle "WordPress\n(fullfrontend.be)" as wp
      rectangle "n8n\n(n8n/webhook.fullfrontend.be)" as n8n
      rectangle "CRM (futur)" as crm
      rectangle "Nextcloud\n(cloud.fullfrontend.be)" as nc
      rectangle "Mailu\n(mail.fullfrontend.be)" as mailu
    }
  }

  database "DO Spaces\n(backups, médias)" as spaces

  dns --> traefik : HTTP(S)
  traefik --> wp
  traefik --> n8n
  traefik --> crm
  traefik --> nc
  traefik --> mailu

  extdns --> traefik : Gère les ingress\n(et mailu)
  cert --> traefik  : ACME/TLS
  pg --> velero_do
  mariadb --> velero_do
  velero_do --> spaces : Backups
  wp --> mariadb
  n8n --> pg
  crm --> pg
  crm --> mariadb
  nc --> pg
  mailu --> mariadb
  wp --> spaces : Médias (plugin S3)
}

dns_cur -[#888,dashed]-> dns : Migration DNS DO
miab_nc -[#888,dashed]-> nc : Migration Nextcloud
wp_cur -[#888,dashed]-> wp : Migration WordPress
mautic_cur -[#888,dashed]-> crm : Remplacement/CRM futur
miab_mail -[#888,dashed]-> mailu : Migration mail

legend right
  Étapes de transition (flèches en pointillés)
  - DNS/ingress : bascule vers Traefik + external-dns
  - Apps : WP → WordPress chart, Mautic → CRM futur, Nextcloud → NC chart
  - Mail : Mailinabox → Mailu
  - Backups : Velero vers Spaces
endlegend

@enduml
