@startuml
title FFE – Architecture cible Kubernetes (root_domain = fullfrontend.be)

skinparam rectangle {
  BackgroundColor<<infra>> #dfe9ff
  BackgroundColor<<data>>  #e8ffe8
  BackgroundColor<<apps>>  #ffe8e8
  BorderColor #777
}
skinparam shadowing false

rectangle "Internet / DNS" as dns {
  rectangle "FQDN:\n- fullfrontend.be (WordPress)\n- n8n.fullfrontend.be\n- webhook.fullfrontend.be\n- cloud.fullfrontend.be\n- mail.fullfrontend.be" as fqdn
}

rectangle "Cluster DOKS (prod)" {
  rectangle "Namespace infra" <<infra>> {
    rectangle "Traefik\n(Ingress)" as traefik
    rectangle "cert-manager" as cert
    rectangle "external-dns" as extdns
    rectangle "Velero\n(backups → Spaces)" as velero_do
  }

  rectangle "Namespace data" <<data>> {
    rectangle "Postgres\n(StatefulSet + PVC)" as pg
    rectangle "MariaDB\n(StatefulSet + PVC)" as mariadb
  }

  rectangle "Namespace apps" <<apps>> {
    rectangle "WordPress\n(fullfrontend.be)" as wp
    rectangle "n8n\n(n8n/webhook.fullfrontend.be)" as n8n
    rectangle "CRM (futur)" as crm
    rectangle "Nextcloud\n(cloud.fullfrontend.be)" as nc
    rectangle "Mailu\n(mail.fullfrontend.be)" as mailu
  }
}

database "DO Spaces\n(backups, médias)" as spaces

dns --> traefik : HTTP(S)
traefik --> wp
traefik --> n8n
traefik --> crm
traefik --> nc
traefik --> mailu

extdns --> traefik : Gère les ingress\n(et mailu)
cert --> traefik  : ACME/TLS
pg --> velero_do
mariadb --> velero_do
velero_do --> spaces : Backups
wp --> mariadb
n8n --> pg
crm --> pg
crm --> mariadb
nc --> pg
mailu --> mariadb
wp --> spaces : Médias (plugin S3)

legend right
  infra : Traefik, cert-manager, external-dns, Velero
  data  : Postgres, MariaDB (PVC bloc)
  apps  : WordPress, n8n, CRM, Nextcloud, Mailu
  stockage bloc : PVC DO CSI
  stockage objet : Spaces (backups, médias WP)
endlegend

@enduml
