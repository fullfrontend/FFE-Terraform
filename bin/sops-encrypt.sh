#!/usr/bin/env bash
set -euo pipefail

if [[ $# -ne 2 ]]; then
  echo "Usage: $0 <plaintext.tfvars> <output.tfvars.enc>" >&2
  exit 1
fi

PLAINTEXT="$1"
OUTPUT="$2"

if [[ ! -f "$PLAINTEXT" ]]; then
  echo "Input file not found: $PLAINTEXT" >&2
  exit 1
fi

if [[ -z "${SOPS_AGE_RECIPIENTS:-}" ]]; then
  echo "SOPS_AGE_RECIPIENTS is not set. Run bin/age-init.sh and export the vars." >&2
  exit 1
fi

get_tfvar_string() {
  local key="$1"
  local file="$2"
  local matcher

  if command -v rg >/dev/null 2>&1; then
    matcher="rg"
  else
    matcher="grep -E"
  fi

  $matcher "^[[:space:]]*${key}[[:space:]]*=" "$file" | \
    sed -nE "s/^[[:space:]]*${key}[[:space:]]*=[[:space:]]*\"([^\"]*)\".*/\\1/p" | \
    head -n1 || true
}

generate_security_txt_signature() {
  local file="$1"
  local contact_email
  local host

  contact_email="$(get_tfvar_string "wp_security_contact_email" "$file")"
  if [[ -z "$contact_email" ]]; then
    contact_email="$(get_tfvar_string "acme_email" "$file")"
  fi

  if [[ -z "$contact_email" ]]; then
    echo "No contact email found (wp_security_contact_email or acme_email) in $file." >&2
    return 1
  fi

  host="$(get_tfvar_string "root_domain_prod" "$file")"
  if [[ -z "$host" ]]; then
    host="$(get_tfvar_string "root_domain_dev" "$file")"
  fi
  if [[ -z "$host" ]]; then
    host="$(awk '
      $0 ~ /variable "root_domain_prod"/ { invar = 1 }
      invar && $0 ~ /default/ {
        if (match($0, /"[^"]+"/)) {
          print substr($0, RSTART + 1, RLENGTH - 2)
          exit
        }
      }
      invar && $0 ~ /^}/ { invar = 0 }
    ' variables.tf)"
  fi

  if [[ -z "$host" ]]; then
    echo "No root domain found (root_domain_prod/root_domain_dev or variables.tf default)." >&2
    return 1
  fi

  local tmp_dir
  local tmp_security_txt
  local tmp_security_sig
  local signature_url

  tmp_dir="$(mktemp -d)"
  tmp_security_txt="${tmp_dir}/security.txt"
  tmp_security_sig="${tmp_dir}/security.txt.asc"
  signature_url="https://${host}/security.txt.sig"

  cat > "$tmp_security_txt" <<EOF
Contact: mailto:${contact_email}
Signature: ${signature_url}
EOF

  gpg --local-user "$contact_email" --armor --detach-sign "$tmp_security_txt"
  if [[ ! -f "$tmp_security_sig" ]]; then
    echo "Failed to generate security.txt signature with GPG." >&2
    return 1
  fi

  local tmp_out
  tmp_out="$(mktemp)"

  awk '
    BEGIN { skip = 0 }
    /^[[:space:]]*(wp_security_txt|wp_security_txt_sig|wp_security_txt_signature_url)[[:space:]]*=/ {
      if ($0 ~ /<<-?EOT/) { skip = 1 }
      next
    }
    skip == 1 {
      if ($0 ~ /^EOT$/) { skip = 0 }
      next
    }
    { print }
  ' "$file" > "$tmp_out"

  {
    echo ""
    echo "# WordPress security.txt signature (generated by bin/sops-encrypt.sh)"
    echo "wp_security_txt = <<-EOT"
    cat "$tmp_security_txt"
    echo "EOT"
    echo ""
    echo "wp_security_txt_sig = <<-EOT"
    cat "$tmp_security_sig"
    echo "EOT"
  } >> "$tmp_out"

  mv "$tmp_out" "$file"
  rm -rf "$tmp_dir"
}

generate_security_txt_signature "$PLAINTEXT"

sops -e "$PLAINTEXT" > "$OUTPUT"
echo "Encrypted -> $OUTPUT (keep $PLAINTEXT$([[ "$PLAINTEXT" =~ \.enc$ ]] && echo '' || echo ' out of git'))."
